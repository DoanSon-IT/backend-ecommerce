package com.sondv.phone.service;

import com.sondv.phone.dto.*;
import com.sondv.phone.model.*;
import com.sondv.phone.repository.*;
import jakarta.persistence.criteria.Predicate;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.OffsetDateTime;
import java.time.ZoneOffset;
import java.util.ArrayList;
import java.util.List;

@Service
@RequiredArgsConstructor
public class OrderService {

    private final OrderRepository orderRepository;
    private final CustomerRepository customerRepository;
    private final DiscountRepository discountRepository;
    private final ProductRepository productRepository;
    private final OrderDetailRepository orderDetailRepository;
    private final InventoryService inventoryService;

    @Transactional
    public Order createOrder(User user, OrderRequest orderRequest) {
        if (orderRequest.getProductIds().size() != orderRequest.getQuantities().size()) {
            throw new IllegalArgumentException("S·ªë l∆∞·ª£ng s·∫£n ph·∫©m v√† s·ªë l∆∞·ª£ng kh√¥ng kh·ªõp.");
        }

        Customer customer = customerRepository.findByUserId(user.getId())
                .orElseGet(() -> {
                    Customer newCustomer = new Customer();
                    newCustomer.setUser(user);
                    return customerRepository.save(newCustomer);
                });

        Order order = new Order();
        order.setCustomer(customer);
        order.setStatus(OrderStatus.PENDING);
        order.setCreatedAt(LocalDateTime.now());

        List<OrderDetail> orderDetails = new ArrayList<>();
        BigDecimal totalPriceBeforeDiscount = BigDecimal.ZERO;
        OffsetDateTime now = OffsetDateTime.now();

        // ‚úÖ L·∫∑p qua c√°c s·∫£n ph·∫©m trong gi·ªè
        for (int i = 0; i < orderRequest.getProductIds().size(); i++) {
            Long productId = orderRequest.getProductIds().get(i);
            int quantity = orderRequest.getQuantities().get(i);

            Inventory inventory = inventoryService.getInventoryByProduct(productId)
                    .orElseThrow(() -> new RuntimeException("Kh√¥ng t√¨m th·∫•y t·ªìn kho cho s·∫£n ph·∫©m ID: " + productId));

            if (inventory.getQuantity() < quantity) {
                throw new RuntimeException("S·∫£n ph·∫©m '" + inventory.getProduct().getName() + "' kh√¥ng ƒë·ªß h√†ng.");
            }

            inventoryService.adjustInventory(productId, -quantity, "T·∫°o ƒë∆°n h√†ng", user.getId());

            Product product = inventory.getProduct();

            // ‚ùå Kh√¥ng cho √°p m√£ n·∫øu c√≥ khuy·∫øn m√£i ƒëang ho·∫°t ƒë·ªông
            if (product.getDiscountedPrice() != null &&
                    product.getDiscountStartDate() != null &&
                    product.getDiscountEndDate() != null) {

                OffsetDateTime start = product.getDiscountStartDate().atOffset(ZoneOffset.UTC);
                OffsetDateTime end = product.getDiscountEndDate().atOffset(ZoneOffset.UTC);

                boolean isDiscountActive = !now.isBefore(start) && !now.isAfter(end);
                if (isDiscountActive && orderRequest.getDiscountCode() != null) {
                    throw new IllegalArgumentException("S·∫£n ph·∫©m '" + product.getName() + "' ƒëang khuy·∫øn m√£i, kh√¥ng th·ªÉ √°p m√£.");
                }
            }

            BigDecimal price = product.getSellingPrice();
            OrderDetail detail = new OrderDetail();
            detail.setOrder(order);
            detail.setProduct(product);
            detail.setQuantity(quantity);
            detail.setPrice(price);
            orderDetails.add(detail);

            totalPriceBeforeDiscount = totalPriceBeforeDiscount.add(price.multiply(BigDecimal.valueOf(quantity)));
        }

        order.setOrderDetails(orderDetails);

        // ‚úÖ √Åp m√£ gi·∫£m gi√° (n·∫øu c√≥)
        Discount appliedDiscount = null;
        BigDecimal discountAmount = BigDecimal.ZERO;

        if (orderRequest.getDiscountCode() != null && !orderRequest.getDiscountCode().isBlank()) {
            appliedDiscount = discountRepository.findByCode(orderRequest.getDiscountCode())
                    .orElseThrow(() -> new IllegalArgumentException("‚ùå M√£ gi·∫£m gi√° kh√¥ng t·ªìn t·∫°i."));

            if (appliedDiscount.isUsed()) {
                throw new IllegalArgumentException("‚ùå M√£ gi·∫£m gi√° ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng.");
            }

            if (now.isBefore(appliedDiscount.getValidFrom())) {
                throw new IllegalArgumentException("‚è≥ M√£ gi·∫£m gi√° ch∆∞a c√≥ hi·ªáu l·ª±c.");
            }
            if (now.isAfter(appliedDiscount.getValidTo())) {
                throw new IllegalArgumentException("‚õî M√£ gi·∫£m gi√° ƒë√£ h·∫øt h·∫°n.");
            }

            if (totalPriceBeforeDiscount.compareTo(BigDecimal.valueOf(appliedDiscount.getMinOrderValue())) < 0) {
                throw new IllegalArgumentException("üõí ƒê∆°n h√†ng ch∆∞a ƒë·∫°t ƒëi·ªÅu ki·ªán t·ªëi thi·ªÉu ƒë·ªÉ √°p m√£.");
            }

            discountAmount = totalPriceBeforeDiscount
                    .multiply(BigDecimal.valueOf(appliedDiscount.getDiscountPercentage()))
                    .divide(BigDecimal.valueOf(100));

            appliedDiscount.setUsed(true);
            discountRepository.save(appliedDiscount);
        }

        // ‚úÖ Shipping
        ShippingInfo shippingInfo = new ShippingInfo();
        shippingInfo.setOrder(order);
        shippingInfo.setAddress(orderRequest.getAddress());
        shippingInfo.setPhoneNumber(orderRequest.getPhoneNumber());
        shippingInfo.setCarrier(orderRequest.getCarrier());
        shippingInfo.setShippingFee(orderRequest.getShippingFee());
        shippingInfo.setEstimatedDelivery(orderRequest.getEstimatedDelivery());
        order.setShippingInfo(shippingInfo);

        // ‚úÖ T·ªïng ti·ªÅn cu·ªëi c√πng
        BigDecimal shippingFee = orderRequest.getShippingFee() != null ? orderRequest.getShippingFee() : BigDecimal.ZERO;
        BigDecimal finalTotal = totalPriceBeforeDiscount.subtract(discountAmount).add(shippingFee);

        order.setTotalPrice(finalTotal);
        if (appliedDiscount != null) {
            order.setDiscount(appliedDiscount);
        }

        return orderRepository.save(order);
    }

    private BigDecimal resolveCurrentPrice(Product product) {
        OffsetDateTime now = OffsetDateTime.now();

        boolean inDiscountPeriod = product.getDiscountedPrice() != null
                && product.getDiscountStartDate() != null
                && product.getDiscountEndDate() != null
                && now.isAfter(product.getDiscountStartDate().atOffset(now.getOffset()))
                && now.isBefore(product.getDiscountEndDate().atOffset(now.getOffset()));

        return inDiscountPeriod ? product.getDiscountedPrice() : product.getSellingPrice();
    }

    @Transactional
    public Order cancelOrder(Long orderId, User user) {
        Order order = orderRepository.findById(orderId)
                .orElseThrow(() -> new RuntimeException("Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng!"));

        // Ki·ªÉm tra quy·ªÅn (user ch·ªâ ƒë∆∞·ª£c h·ªßy ƒë∆°n h√†ng c·ªßa m√¨nh, ho·∫∑c Admin ƒë∆∞·ª£c quy·ªÅn h·ªßy b·∫•t k·ª≥ ƒë∆°n n√†o)
        if (!order.getCustomer().getUser().getId().equals(user.getId()) &&
                user.getRoles().stream().noneMatch(role -> role == RoleName.ADMIN || role == RoleName.STAFF)) {
            throw new RuntimeException("B·∫°n kh√¥ng c√≥ quy·ªÅn h·ªßy ƒë∆°n h√†ng n√†y!");
        }

        // Ki·ªÉm tra tr·∫°ng th√°i cho ph√©p h·ªßy
        if (!(order.getStatus() == OrderStatus.PENDING )) {
            throw new RuntimeException("ƒê∆°n h√†ng n√†y kh√¥ng th·ªÉ h·ªßy ·ªü tr·∫°ng th√°i hi·ªán t·∫°i!");
        }

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng th√†nh CANCELLED
        order.setStatus(OrderStatus.CANCELLED);
        orderRepository.save(order);

        // Ho√†n l·∫°i s·ªë l∆∞·ª£ng t·ªìn kho
        for (OrderDetail detail : order.getOrderDetails()) {
            inventoryService.adjustInventory(
                    detail.getProduct().getId(),
                    detail.getQuantity(), // ho√†n l·∫°i s·ªë l∆∞·ª£ng
                    "H·ªßy ƒë∆°n h√†ng",
                    user.getId()
            );
        }

        return order;
    }

    public Page<OrderResponse> getPaginatedOrders(User user,
                                                  int page,
                                                  int size,
                                                  String sortField,
                                                  String sortDirection,
                                                  String status,
                                                  String customerName,
                                                  String orderId,
                                                  LocalDate startDate,
                                                  LocalDate endDate) {

        Sort.Direction direction = Sort.Direction.fromString(sortDirection.toUpperCase());
        Pageable pageable = PageRequest.of(page - 1, size, Sort.by(direction, sortField));

        Specification<Order> spec = (root, query, cb) -> {
            Predicate predicate = cb.conjunction();

            // N·∫øu kh√¥ng ph·∫£i Admin/Staff ‚Üí ch·ªâ l·∫•y ƒë∆°n c·ªßa kh√°ch h√†ng ƒë√≥
            boolean isAdmin = user.getRoles().stream().anyMatch(r -> r == RoleName.ADMIN || r == RoleName.STAFF);
            if (!isAdmin) {
                Customer customer = customerRepository.findByUserId(user.getId())
                        .orElseThrow(() -> new RuntimeException("Kh√¥ng t√¨m th·∫•y th√¥ng tin kh√°ch h√†ng!"));
                predicate = cb.and(predicate, cb.equal(root.get("customer").get("id"), customer.getId()));
            }

            if (status != null && !status.isBlank()) {
                predicate = cb.and(predicate, cb.equal(root.get("status"), OrderStatus.valueOf(status)));
            }

            if (customerName != null && !customerName.isBlank()) {
                predicate = cb.and(predicate,
                        cb.like(cb.lower(root.get("customer").get("user").get("fullName")),
                                "%" + customerName.toLowerCase() + "%"));
            }

            if (orderId != null && !orderId.isBlank()) {
                predicate = cb.and(predicate,
                        cb.like(cb.function("STR", String.class, root.get("id")),
                                "%" + orderId + "%"));
            }

            if (startDate != null) {
                predicate = cb.and(predicate, cb.greaterThanOrEqualTo(root.get("createdAt"),
                        startDate.atStartOfDay()));
            }

            if (endDate != null) {
                predicate = cb.and(predicate, cb.lessThanOrEqualTo(root.get("createdAt"),
                        endDate.plusDays(1).atStartOfDay()));
            }

            return predicate;
        };

        Page<Order> ordersPage = orderRepository.findAll(spec, pageable);
        return ordersPage.map(this::mapToOrderResponse);
    }

    public OrderResponse mapToOrderResponse(Order order) {
        OrderResponse dto = new OrderResponse();
        dto.setId(order.getId());
        dto.setStatus(order.getStatus().name());
        dto.setCreatedAt(order.getCreatedAt());
        dto.setTotalPrice(order.getTotalPrice());

        // ‚úÖ Ki·ªÉm tra null tr√°nh l·ªói
        if (order.getCustomer() != null && order.getCustomer().getUser() != null) {
            CustomerInfoDTO customerDTO = new CustomerInfoDTO();
            customerDTO.setFullName(order.getCustomer().getUser().getFullName());
            customerDTO.setEmail(order.getCustomer().getUser().getEmail());
            dto.setCustomer(customerDTO);
        }

        // Shipping info
        if (order.getShippingInfo() != null) {
            ShippingInfoDTO shippingDTO = new ShippingInfoDTO();
            shippingDTO.setAddress(order.getShippingInfo().getAddress());
            shippingDTO.setPhoneNumber(order.getShippingInfo().getPhoneNumber());
            shippingDTO.setCarrier(order.getShippingInfo().getCarrier());
            shippingDTO.setShippingFee(order.getShippingInfo().getShippingFee());
            shippingDTO.setEstimatedDelivery(order.getShippingInfo().getEstimatedDelivery());
            dto.setShippingInfo(shippingDTO);
        }

        // Chi ti·∫øt ƒë∆°n h√†ng
        List<OrderDetailResponse> detailDTOs = order.getOrderDetails().stream().map(detail -> {
            OrderDetailResponse d = new OrderDetailResponse();
            d.setId(detail.getId());
            d.setProductName(detail.getProduct().getName());
            d.setQuantity(detail.getQuantity());
            d.setPrice(detail.getPrice());
            String productImageUrl = detail.getProduct().getImages().stream()
                    .findFirst()
                    .map(ProductImage::getImageUrl)
                    .orElse("/images/default.png");
            d.setProductImage(productImageUrl);
            return d;
        }).toList();

        dto.setOrderDetails(detailDTOs);
        return dto;
    }
}
